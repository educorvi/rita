# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Build, Test & Release

on:
    push:
        branches: ['main', 'develop']
    pull_request:
        branches: ['develop']

jobs:
    buildAndTest:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x, 22.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        env:
            # Persistent Rita
            MYSQL_DATABASE: prita
            MYSQL_HOST: localhost
            MYSQL_USER: root
            MYSQL_PASSWORD: root
            PSQL_DATABASE: postgres
            PSQL_HOST: localhost
            PSQL_USER: postgres
            PSQL_PASSWORD: postgres
            # Rita Http
            PORT: 3000
            LOGLEVEL: info
            DB_TYPE: POSTGRES
            DB_HOST: localhost
            DB_PORT: 5432
            DB_USERNAME: postgres
            DB_PASSWORD: postgres
            DB_DATABASE: postgres
        # Service containers to run with `container-job`
        services:
            # Label used to access the service container
            postgres:
                # Docker Hub image
                image: postgres
                # Provide the password for postgres
                env:
                    POSTGRES_PASSWORD: postgres

                # Set health checks to wait until postgres has started
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    # Maps tcp port 5432 on service container to the host
                    - 5432:5432
            mysql:
                image: mysql:5.7
                env:
                    MYSQL_DATABASE: prita
                    MYSQL_ROOT_PASSWORD: root
                ports:
                    - 3306:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: yarn
            - name: Cache Turbo
              uses: actions/cache@v3
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-
            - name: Install dependencies
              run: yarn install --immutable
            - name: Build
              run: yarn build
            - name: Test
              run: yarn test

    #    licenses:
    #        runs-on: ubuntu-latest
    #        if: github.event_name != 'pull_request'
    #        steps:
    #            - uses: actions/checkout@v3
    #            - uses: actions/setup-node@v3
    #            - name: Cache Rush
    #              uses: actions/cache@v3
    #              with:
    #                  path: |
    #                      common/temp/install-run
    #                      ~/.rush
    #                  key: ${{ runner.os }}-${{ hashFiles('rush.json') }}
    #            - name: Cache pnpm
    #              uses: actions/cache@v3
    #              with:
    #                  path: |
    #                      common/temp/pnpm-store
    #                  key: ${{ runner.os }}-${{ hashFiles('common/config/rush/pnpm-lock.yaml') }}
    #            - name: Install dependencies
    #              run: node common/scripts/install-run-rush.js install
    #            - name: FOSSA Scan
    #              uses: fossas/fossa-action@main
    #              with:
    #                  api-key: ${{secrets.FOSSA_API_TOKEN}}
    #            - name: 'Run FOSSA Test'
    #              uses: fossas/fossa-action@main
    #              with:
    #                  api-key: ${{secrets.FOSSA_API_TOKEN}}
    #                  run-tests: true

    release:
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        runs-on: ubuntu-latest
        needs: [buildAndTest]
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - uses: actions/setup-node@v3
              with:
                  cache: yarn
            - name: Setup git
              run: |
                  git config user.name 'github-actions[bot]'
                  git config user.email 'github-actions[bot]@users.noreply.github.com'
            - name: Install dependencies
              run: yarn install --immutable
            - name: Build
              run: yarn build
            - name: Generate documentation
              run: yarn generate-documentation
            - name: Configure NPM
              run: |
                  echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
            - name: Publish to NPM
              run: |
                  # TODO: Consider using yarn workspaces foreach or changesets for better version management
                  for package_dir in rita-core persistent-rita rita-smt/node-smtlib rita-smt/main plugins/http; do
                    if [ -f "$package_dir/package.json" ]; then
                      cd "$package_dir"
                      # Check if package should be published by looking at package.json
                      if grep -q '"private".*:.*true' package.json; then
                        echo "Skipping $package_dir (private package)"
                      else
                        npm publish --access public || echo "Failed to publish $package_dir or already published"
                      fi
                      cd -
                    fi
                  done
            - name: Commit documentation changes
              run: |
                  git add docs || true
                  git commit -m 'chore: update documentation [skip ci]' || echo "No changes to commit"
                  git push --follow-tags || true
            - name: Rebase develop
              run: |
                  git branch
                  git checkout develop || echo "No develop branch"
                  git pull || true
                  git rebase main || true
                  git push --follow-tags || true
    buildDocker:
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        needs: [release]
        uses: ./.github/workflows/docker.yml
        secrets: inherit
    githubPackages:
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        needs: [release]
        uses: ./.github/workflows/github_packages.yml
        secrets: inherit
    deploy:
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        needs: [release]
        uses: ./.github/workflows/deploy.yml
        secrets: inherit
